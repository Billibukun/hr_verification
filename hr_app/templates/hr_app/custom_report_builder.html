{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .field-select {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        max-height: 300px;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
    }
    .field-select label {
        display: flex;
        align-items: center;
        padding: 5px;
        border: 1px solid #e2e8f0;
        border-radius: 0.25rem;
        transition: all 0.3s;
    }
    .field-select label:hover {
        background-color: #f7fafc;
    }
    .field-select input[type="checkbox"] {
        margin-right: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-6 flex justify-between items-center">
        <h1 class="text-3xl font-bold text-primary">Custom Report Builder</h1>
        <a href="{{ request.META.HTTP_REFERER }}" class="bg-primary hover:bg-accent text-white font-bold py-2 px-4 rounded transition duration-300">Back</a>
    </div>

    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
        <form method="post" id="reportForm">
            {% csrf_token %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    {{ form.name|as_crispy_field }}
                </div>
                <div>
                    {{ form.model_name|as_crispy_field }}
                </div>
            </div>

            <div class="mb-6">
                {{ form.description|as_crispy_field }}
            </div>

            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2">Select Fields</label>
                <div id="fieldsContainer" class="field-select">
                    <!-- Fields will be dynamically populated here -->
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    {{ form.order_by|as_crispy_field }}
                </div>
                <div>
                    {{ form.items_per_page|as_crispy_field }}
                </div>
            </div>

            <div class="flex justify-end">
                <button type="submit" class="bg-primary hover:bg-accent text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300">
                    Create Report
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        $('#id_model_name').select2();
        $('#id_order_by').select2();

        function updateFields() {
            var modelName = $('#id_model_name').val();
            $.ajax({
                url: '{% url "get_model_fields" %}',
                data: {
                    'model_name': modelName
                },
                dataType: 'json',
                success: function(data) {
                    var fieldsContainer = $('#fieldsContainer');
                    fieldsContainer.empty();
                    $.each(data.fields, function(index, field) {
                        fieldsContainer.append(
                            '<label><input type="checkbox" name="fields" value="' + field[0] + '"> ' + field[1] + '</label>'
                        );
                    });
                    
                    var orderBySelect = $('#id_order_by');
                    orderBySelect.empty();
                    orderBySelect.append('<option value="">---------</option>');
                    $.each(data.fields, function(index, field) {
                        orderBySelect.append('<option value="' + field[0] + '">' + field[1] + '</option>');
                    });
                    orderBySelect.trigger('change');
                }
            });
        }

        $('#id_model_name').change(updateFields);
        updateFields();  // Call on page load to populate fields for initial model
    });
</script>
{% endblock %}